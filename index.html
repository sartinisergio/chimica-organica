<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Programmi Chimica Organica - Zanichelli v4.2 TEST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4F46E5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <div class="flex items-center space-x-2">
                            <h1 class="text-2xl font-bold text-gray-900">Analisi Programmi v4.2</h1>
                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">TEST</span>
                            <span id="apiKeyBadge" class="hidden px-2 py-1 text-xs font-medium rounded-full"></span>
                        </div>
                        <p class="text-sm text-gray-500">Chimica Organica - Zanichelli (Raccomandazioni Deterministiche)</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showView('upload')" id="btnUpload" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Nuova Analisi
                    </button>
                    <button onclick="showView('storico')" id="btnStorico" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Storico
                    </button>
                    <button onclick="showView('settings')" id="btnSettings" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center space-x-1">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span>Impostazioni</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Banner Miglioramento -->
    <div class="max-w-7xl mx-auto px-4 pt-4 sm:px-6 lg:px-8">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-green-900">✅ Versione v4.1 con Proxy Sicuro</h3>
                <p class="text-sm text-green-800 mt-1">Questa versione utilizza un <strong>backend proxy sicuro</strong> per le chiamate API, risolvendo i problemi CORS. Le raccomandazioni Zanichelli rimangono <strong>consistenti e deterministiche</strong>.</p>
            </div>
        </div>
    </div>

    <!-- Banner Benvenuto (solo per nuovi utenti) -->
    <div id="welcomeBanner" class="hidden max-w-7xl mx-auto px-4 pt-6 sm:px-6 lg:px-8">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start space-x-3">
            <svg class="h-6 w-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
                <h3 class="text-sm font-medium text-blue-900">Benvenuto! Configurazione necessaria</h3>
                <p class="text-sm text-blue-800 mt-1">Prima di iniziare, devi configurare la tua chiave API OpenAI. Clicca su <strong>Impostazioni</strong> per procedere.</p>
                <button onclick="showView('settings'); document.getElementById('welcomeBanner').classList.add('hidden');" class="mt-2 text-sm font-medium text-blue-600 hover:text-blue-700">
                    Vai alle Impostazioni →
                </button>
            </div>
            <button onclick="document.getElementById('welcomeBanner').classList.add('hidden')" class="text-blue-400 hover:text-blue-600">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        
        <!-- Settings View -->
        <div id="viewSettings" class="hidden">
            <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Configurazione AI Provider</h2>
                
                <div class="space-y-6">
                    <!-- Provider Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Provider AI</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="selectProvider('openai')" id="btnProviderOpenAI" class="px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100">
                                OpenAI
                            </button>
                            <button onclick="selectProvider('perplexity')" id="btnProviderPerplexity" class="px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50">
                                Perplexity
                            </button>
                        </div>
                    </div>

                    <!-- OpenAI Configuration -->
                    <div id="configOpenAI" class="space-y-4">
                        <div class="border-t pt-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Configurazione OpenAI</h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chiave API OpenAI</label>
                                    <input type="password" id="apiKeyOpenAI" placeholder="sk-proj-xxxxxxxxxxxxx" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">La chiave viene salvata solo nel tuo browser. <a href="https://platform.openai.com/api-keys" target="_blank" class="text-indigo-600 hover:underline">Ottieni chiave</a></p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modello OpenAI</label>
                                    <select id="modelOpenAI" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="gpt-4.1-mini">gpt-4.1-mini (Economico, veloce)</option>
                                        <option value="gpt-4o">gpt-4o (Bilanciato)</option>
                                        <option value="gpt-4-turbo">gpt-4-turbo (Potente)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Perplexity Configuration -->
                    <div id="configPerplexity" class="space-y-4 hidden">
                        <div class="border-t pt-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Configurazione Perplexity</h3>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chiave API Perplexity</label>
                                    <input type="password" id="apiKeyPerplexity" placeholder="pplx-xxxxxxxxxxxxx" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">La chiave viene salvata solo nel tuo browser. <a href="https://www.perplexity.ai/settings/api" target="_blank" class="text-indigo-600 hover:underline">Ottieni chiave</a></p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Modello Perplexity</label>
                                    <select id="modelPerplexity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="llama-3.1-sonar-large-128k-online">Sonar (Economico, veloce)</option>
                                        <option value="llama-3.1-sonar-huge-128k-online">Sonar Pro (Potente, costoso)</option>
                                        <option value="llama-3.1-sonar-large-128k-reasoning">Sonar Reasoning (Con ragionamento)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Sonar è raccomandato per il miglior rapporto qualità/prezzo</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <button onclick="saveConfiguration()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                        Salva Configurazione
                    </button>
                    
                    <!-- Status Message -->
                    <div id="configStatus" class="hidden p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        
        <!-- Upload View -->
        <div id="viewUpload" class="hidden">
            <div class="max-w-4xl mx-auto space-y-6">
                
                <!-- Step 1: Informazioni Contesto -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">1. Informazioni sul Contesto</h2>
                    <p class="text-sm text-gray-600 mb-6">Fornisci informazioni sul contesto didattico e il manuale adottato</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contesto Didattico *</label>
                            <select id="contestoSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona contesto...</option>
                                <option value="L-2">L-2: Biotecnologie</option>
                                <option value="L-13">L-13: Scienze biologiche</option>
                                <option value="L-25">L-25: Agraria</option>
                                <option value="L-29">L-29: Scienze farmaceutiche</option>
                                <option value="L-32">L-32: Scienze naturali/ambientali</option>
                                <option value="L-38">L-38: Scienze zootecniche</option>
                                <option value="L-8/9">L-8/9: Ingegneria</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manuale Principale *</label>
                            <select id="manualeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Seleziona manuale principale...</option>
                                <option value="Botta">Botta (EdiErmes)</option>
                                <option value="Brown">Brown (Edises)</option>
                                <option value="Bruice">Bruice (Edises)</option>
                                <option value="GorzynskiSmith">Gorzynski Smith (McGraw-Hill)</option>
                                <option value="Wade">Wade (Piccin)</option>
                                <option value="Altro">Altro/Non specificato</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Il manuale principale sarà analizzato in dettaglio</p>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Manuali Alternativi (opzionale)</label>
                            <p class="text-xs text-gray-500 mb-2">Seleziona eventuali manuali alternativi per un confronto rapido</p>
                            <div class="space-y-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBotta" value="Botta" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Botta (EdiErmes)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBrown" value="Brown" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Brown (Edises)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altBruice" value="Bruice" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Bruice (Edises)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altGorzynski" value="GorzynskiSmith" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Gorzynski Smith (McGraw-Hill)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altWade" value="Wade" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Wade (Piccin)</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                    <input type="checkbox" id="altAltro" value="Altro" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <span class="text-sm text-gray-700">Altro/Non specificato</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CFU (Crediti)</label>
                            <input type="number" id="cfuInput" placeholder="es. 9" min="1" max="20"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ore Totali</label>
                            <input type="number" id="oreInput" placeholder="es. 72" min="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Carica Programma -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-2">2. Carica Programma Universitario</h2>
                    <p class="text-sm text-gray-600 mb-6">Carica un file PDF o incolla il testo del programma</p>
                    
                    <div class="space-y-6">
                        <!-- Upload File -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carica File (PDF o TXT)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" accept=".pdf,.txt" class="hidden" onchange="handleFileSelect(event)">
                                <svg class="h-12 w-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p id="fileNameDisplay" class="text-sm text-gray-600">Clicca per selezionare un file</p>
                                <p class="text-xs text-gray-500 mt-2">PDF o TXT (max 16 MB)</p>
                            </div>
                        </div>

                        <!-- Oppure -->
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                            <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">oppure</span></div>
                        </div>

                        <!-- Textarea -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Incolla il Testo</label>
                            <textarea id="testoInput" placeholder="Incolla qui il testo del programma universitario..." 
                                      class="w-full h-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
                        </div>

                        <!-- Error -->
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3">
                            <svg class="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p id="errorText" class="text-sm text-red-800"></p>
                        </div>

                        <!-- Button -->
                        <button onclick="avviaAnalisi()" id="btnAnalizza" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-lg font-medium flex items-center justify-center">
                            <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Avvia Analisi Completa
                        </button>
                        <div id="loadingMessage" class="hidden text-center space-y-2">
                            <div class="spinner mx-auto"></div>
                            <p class="text-sm text-gray-600" id="loadingText">Analisi in corso...</p>
                            <p class="text-xs text-gray-500">Questo può richiedere 30-60 secondi</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risultati View -->
        <div id="viewRisultati" class="hidden">
            <!-- Contenuto dinamico generato da JavaScript -->
        </div>

        <!-- Storico View -->
        <div id="viewStorico" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Storico Analisi</h2>
                <div id="storicoContent" class="space-y-3">
                    <!-- Contenuto dinamico -->
                </div>
            </div>
        </div>

    </main>

    <script>
        // Configurazione PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Database manuali (da report forniti)
        const MANUALI_DB = {
            'Botta': {
                editore: 'EdiErmes',
                caratteristiche: ['Approccio italiano', 'Focus biomolecole', 'Esempi biologici'],
                punti_forza: ['Linguaggio accessibile', 'Applicazioni biologiche', 'Esercizi graduati'],
                target: ['L-13', 'L-2']
            },
            'Brown': {
                editore: 'Edises',
                caratteristiche: ['Approccio problem-solving', 'Molti esercizi', 'Visione moderna'],
                punti_forza: ['Chiarezza espositiva', 'Ricchezza esercizi', 'Aggiornato'],
                target: ['L-13', 'L-29', 'L-32']
            },
            'Bruice': {
                editore: 'Edises',
                caratteristiche: ['Approccio biologico', 'Meccanismi dettagliati', 'Applicazioni mediche'],
                punti_forza: ['Profondità meccanismi', 'Collegamenti biologia', 'Casi clinici'],
                target: ['L-29', 'L-13']
            },
            'GorzynskiSmith': {
                editore: 'McGraw-Hill',
                caratteristiche: ['Approccio visuale', 'Molte illustrazioni', 'Sintesi organica'],
                punti_forza: ['Chiarezza visiva', 'Sintesi organica', 'Meccanismi'],
                target: ['L-13', 'L-29']
            },
            'Wade': {
                editore: 'Piccin',
                caratteristiche: ['Approccio sistematico', 'Meccanismi dettagliati', 'Esercizi'],
                punti_forza: ['Sistematicità', 'Rigore', 'Completezza'],
                target: ['L-13', 'L-29']
            }
        };

        // Variabili globali
        let currentProgramma = null;
        let fileContent = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            checkApiKey();
            showView('upload');
        });

        // Gestione Configurazione
        function checkApiKey() {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const apiKeyOpenAI = localStorage.getItem('openai_api_key');
            const apiKeyPerplexity = localStorage.getItem('perplexity_api_key');
            const badge = document.getElementById('apiKeyBadge');
            
            // Per OpenAI: permetti uso anche senza chiave (userà quella di default su Netlify)
            // Per Perplexity: richiedi sempre la chiave
            const hasKey = (provider === 'openai') || (provider === 'perplexity' && apiKeyPerplexity);
            
            if (hasKey) {
                const providerName = provider === 'openai' ? 'OpenAI' : 'Perplexity';
                const isUsingDefault = provider === 'openai' && !apiKeyOpenAI;
                if (isUsingDefault) {
                    badge.textContent = `✓ ${providerName} (Test)`;
                    badge.className = 'px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full';
                } else {
                    badge.textContent = `✓ ${providerName}`;
                    badge.className = 'px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full';
                }
                badge.classList.remove('hidden');
            } else {
                document.getElementById('welcomeBanner')?.classList.remove('hidden');
                badge.textContent = '⚠ API Non Configurata';
                badge.className = 'px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full';
                badge.classList.remove('hidden');
            }
        }

        // Selezione Provider
        function selectProvider(provider) {
            localStorage.setItem('ai_provider', provider);
            
            // Aggiorna UI bottoni
            const btnOpenAI = document.getElementById('btnProviderOpenAI');
            const btnPerplexity = document.getElementById('btnProviderPerplexity');
            const configOpenAI = document.getElementById('configOpenAI');
            const configPerplexity = document.getElementById('configPerplexity');
            
            if (provider === 'openai') {
                btnOpenAI.className = 'px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100';
                btnPerplexity.className = 'px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50';
                configOpenAI.classList.remove('hidden');
                configPerplexity.classList.add('hidden');
            } else {
                btnPerplexity.className = 'px-4 py-3 border-2 border-indigo-600 bg-indigo-50 text-indigo-700 rounded-lg font-medium transition hover:bg-indigo-100';
                btnOpenAI.className = 'px-4 py-3 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-medium transition hover:bg-gray-50';
                configPerplexity.classList.remove('hidden');
                configOpenAI.classList.add('hidden');
            }
        }

        function saveConfiguration() {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const status = document.getElementById('configStatus');
            
            if (provider === 'openai') {
                const apiKey = document.getElementById('apiKeyOpenAI').value.trim();
                const model = document.getElementById('modelOpenAI').value;
                
                if (!apiKey) {
                    showConfigStatus('Inserisci una chiave API OpenAI valida', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('sk-')) {
                    showConfigStatus('La chiave API OpenAI deve iniziare con "sk-"', 'error');
                    return;
                }
                
                localStorage.setItem('openai_api_key', apiKey);
                localStorage.setItem('openai_model', model);
                showConfigStatus('Configurazione OpenAI salvata con successo!', 'success');
            } else {
                const apiKey = document.getElementById('apiKeyPerplexity').value.trim();
                const model = document.getElementById('modelPerplexity').value;
                
                if (!apiKey) {
                    showConfigStatus('Inserisci una chiave API Perplexity valida', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('pplx-')) {
                    showConfigStatus('La chiave API Perplexity deve iniziare con "pplx-"', 'error');
                    return;
                }
                
                localStorage.setItem('perplexity_api_key', apiKey);
                localStorage.setItem('perplexity_model', model);
                showConfigStatus('Configurazione Perplexity salvata con successo!', 'success');
            }
            
            checkApiKey();
            
            setTimeout(() => {
                showView('upload');
            }, 1500);
        }

        function showConfigStatus(message, type) {
            const status = document.getElementById('configStatus');
            status.textContent = message;
            status.className = `p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            status.classList.remove('hidden');
        }
        
        // Carica configurazione salvata all'apertura settings
        function loadSavedConfiguration() {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const openaiKey = localStorage.getItem('openai_api_key') || '';
            const openaiModel = localStorage.getItem('openai_model') || 'gpt-4.1-mini';
            const perplexityKey = localStorage.getItem('perplexity_api_key') || '';
            const perplexityModel = localStorage.getItem('perplexity_model') || 'llama-3.1-sonar-large-128k-online';
            
            // Imposta provider
            selectProvider(provider);
            
            // Carica valori
            if (document.getElementById('apiKeyOpenAI')) {
                document.getElementById('apiKeyOpenAI').value = openaiKey;
                document.getElementById('modelOpenAI').value = openaiModel;
                document.getElementById('apiKeyPerplexity').value = perplexityKey;
                document.getElementById('modelPerplexity').value = perplexityModel;
            }
        }

        // Gestione views
        function showView(viewName) {
            const views = ['viewSettings', 'viewUpload', 'viewRisultati', 'viewStorico'];
            const buttons = ['btnSettings', 'btnUpload', 'btnStorico'];
            
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            
            buttons.forEach(btn => {
                const button = document.getElementById(btn);
                if (button) {
                    button.classList.remove('bg-indigo-600', 'text-white');
                    button.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                }
            });
            
            document.getElementById('view' + viewName.charAt(0).toUpperCase() + viewName.slice(1)).classList.remove('hidden');
            
            if (viewName === 'storico') {
                loadStorico();
            } else if (viewName === 'settings') {
                loadSavedConfiguration();
            }
            
            const activeBtn = document.getElementById('btn' + viewName.charAt(0).toUpperCase() + viewName.slice(1));
            if (activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
                activeBtn.classList.add('bg-indigo-600', 'text-white');
            }
        }

        // Gestione file
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').textContent = file.name;

            if (file.type === 'application/pdf') {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let text = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        text += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    fileContent = text;
                    document.getElementById('testoInput').value = text;
                } catch (error) {
                    showError('Errore nella lettura del PDF: ' + error.message);
                }
            } else if (file.type === 'text/plain') {
                try {
                    const text = await file.text();
                    fileContent = text;
                    document.getElementById('testoInput').value = text;
                } catch (error) {
                    showError('Errore nella lettura del file: ' + error.message);
                }
            } else {
                showError('Formato file non supportato. Usa PDF o TXT.');
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorMessage').classList.add('hidden');
            }, 5000);
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        // Analisi principale
        async function avviaAnalisi() {
            // Verifica che almeno una chiave API sia configurata
            const provider = localStorage.getItem('ai_provider') || 'openai';
            const apiKeyOpenAI = localStorage.getItem('openai_api_key');
            const apiKeyPerplexity = localStorage.getItem('perplexity_api_key');
            
            // Per OpenAI: permetti uso anche senza chiave (userà quella su Netlify)
            // Per Perplexity: richiedi sempre la chiave
            if (provider === 'perplexity' && !apiKeyPerplexity) {
                showError('Chiave API Perplexity non configurata. Vai in Impostazioni.');
                return;
            }

            const contesto = document.getElementById('contestoSelect').value;
            const manuale = document.getElementById('manualeSelect').value;
            const cfu = document.getElementById('cfuInput').value;
            const ore = document.getElementById('oreInput').value;
            const testo = document.getElementById('testoInput').value.trim();
            
            // Raccogli manuali alternativi
            const manualiAlternativi = [];
            ['altBotta', 'altBrown', 'altBruice', 'altGorzynski', 'altWade', 'altAltro'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked && checkbox.value !== manuale) {
                    manualiAlternativi.push(checkbox.value);
                }
            });

            if (!contesto || !manuale) {
                showError('Seleziona contesto didattico e manuale adottato');
                return;
            }

            if (!testo) {
                showError('Carica un file o incolla il testo del programma');
                return;
            }

            if (testo.length < 100) {
                showError('Il testo del programma è troppo breve (minimo 100 caratteri)');
                return;
            }

            document.getElementById('btnAnalizza').disabled = true;
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                // Fase 1: Estrai metadata
                updateLoadingText('Fase 1/4: Estrazione metadata...');
                const metadata = await callLLM( `Analizza il seguente programma universitario di chimica organica ed estrai i seguenti metadati:

Testo del programma:
${testo.substring(0, 2000)}

Estrai:
- università: nome dell'università
- corso_laurea_nome: nome del corso di laurea
- denominazione_corso: nome del corso/insegnamento
- docente: nome del docente

Rispondi SOLO con un JSON valido, senza altri testi:
{
  "università": "...",
  "corso_laurea_nome": "...",
  "denominazione_corso": "...",
  "docente": "..."
}`, 0.3);

                const metadataObj = JSON.parse(metadata.replace(/```json|```/g, '').trim());

                // Fase 2: Analizza programma (TEMPERATURE ABBASSATA A 0.2)
                updateLoadingText('Fase 2/4: Valutazione programma (5 dimensioni)...');
                const valutazione = await callLLM( `Analizza questo programma universitario di chimica organica secondo il FRAMEWORK DI VALUTAZIONE STRUTTURATO.

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}
- Ore: ${ore || 'Non specificato'}

TESTO PROGRAMMA:
${testo.substring(0, 3000)}

FRAMEWORK DI VALUTAZIONE (270 punti totali):

1. OBIETTIVI FORMATIVI (max 40 punti):
   - Completezza (0-10): Quanto sono completi e articolati
   - Chiarezza e Misurabilità (0-10): Quanto sono espliciti e misurabili
   - Coerenza con standard accademici (0-10): Allineamento con standard nazionali/internazionali
   - Interdisciplinarità (0-10): Collegamenti con altre discipline

2. CONTENUTI PROGRAMMATICI (max 130 punti):
   Valuta la copertura dei 10 MODULI CORE basandoti sulle PRIORITÀ per ${contesto}:
   
   MOD-01 Struttura e legami (0-13): Ibridazione, geometria, legami H
   MOD-02 Nomenclatura (0-13): IUPAC generale e avanzata
   MOD-03 Gruppi funzionali (0-13): Identificazione e proprietà
   MOD-04 Stereochimica (0-13): Isomeria, chiralità, attività ottica
   MOD-05 Meccanismi di reazione (0-13): SN1/SN2, SEA, addizioni, eliminazioni, radicali, cinetica
   MOD-06 Composti aromatici (0-13): Aromaticità e reazioni
   MOD-07 Carbonilici e derivati (0-13): Aldeidi, chetoni, acidi, condensazioni
   MOD-08 Polimeri e macromolecole (0-13): Classificazione, meccanismi, proprietà
   MOD-09 Chimica biomolecole (0-13): Carboidrati, amminoacidi, lipidi, acidi nucleici, metabolismo
   MOD-10 Tecniche sperimentali (0-13): Sintesi, IR, UV, NMR, Massa, Cromatografia
   
   PRIORITÀ SPECIFICHE PER ${contesto}:
   - L-2 Biotecnologie: MOD-09 (biomolecole) FONDAMENTALE, MOD-10 (tecniche) FONDAMENTALE
   - L-13 Scienze Biologiche: MOD-09 (biomolecole) FONDAMENTALE, MOD-04 (stereochimica) FONDAMENTALE
   - L-25 Agraria: MOD-03 (gruppi funzionali) priorità per applicazioni agronomiche
   - L-29 Scienze Farmaceutiche: MOD-04 (stereochimica) CRITICO, MOD-02 (nomenclatura) FONDAMENTALE
   - L-8/9 Ingegneria: MOD-08 (polimeri) FONDAMENTALE, MOD-10 (tecniche) FONDAMENTALE
   - L-32 Scienze Naturali/Ambientali: MOD-08-ARG-05 (degradazione ambientale) FONDAMENTALE
   - L-38 Scienze Zootecniche: MOD-09 (biomolecole) FONDAMENTALE
   
   Organizzazione didattica e materiale (0-13): Qualità supporti, esercizi, esempi

3. METODOLOGIA DIDATTICA (max 40 punti):
   - Didattica attiva (0-10): Esercizi, problem solving, casi studio
   - Materiali didattici (0-10): Varietà e qualità supporti
   - Valutazione e feedback (0-10): Modalità valutazione chiare
   - Supporto allo studente (0-10): Risorse di supporto

4. ALLINEAMENTO CURRICULUM (max 30 punti):
   - Coerenza con altri moduli (0-10): Integrazione con altri insegnamenti
   - Progressione didattica (0-10): Sequenza logica argomenti
   - Flessibilità e personalizzazione (0-10): Adattabilità percorsi

5. RISULTATI ATTESI (max 30 punti):
   - Competenze tecnico-scientifiche (0-10): Solide basi teoriche
   - Competenze trasversali (0-10): Comunicazione, problem solving
   - Preparazione professionale (0-10): Applicabilità professionale

GIUDIZI QUALITATIVI per ogni dimensione:
- Obiettivi: Eccellente / Buono / Sufficiente / Carente
- Contenuti: Molto completo / Completo / Parziale / Limitato
- Metodologia: Innovativa / Tradizionale efficace / Basilare / Assente
- Allineamento: Perfettamente allineato / Allineato / Parzialmente allineato / Non allineato
- Risultati: Chiaramente definiti / Definiti / Vaghi / Non specificati

Rispondi SOLO con un JSON valido:
{
  "obiettivi": {"punteggio": numero_su_40, "giudizio": "...", "note": "..."},
  "contenuti": {"punteggio": numero_su_130, "giudizio": "...", "note": "...", "argomenti_principali": ["..."], "moduli_coperti": ["MOD-01", "MOD-05", ...]},
  "metodologia": {"punteggio": numero_su_40, "giudizio": "...", "note": "..."},
  "allineamento": {"punteggio": numero_su_30, "giudizio": "...", "note": "..."},
  "risultati": {"punteggio": numero_su_30, "giudizio": "...", "note": "..."},
  "sintesi": "sintesi generale considerando le priorità specifiche per ${contesto}"
}`, 0.2);

                const valutazioneObj = JSON.parse(valutazione.replace(/```json|```/g, '').trim());
                const totale = valutazioneObj.obiettivi.punteggio + valutazioneObj.contenuti.punteggio + 
                               valutazioneObj.metodologia.punteggio + valutazioneObj.allineamento.punteggio + 
                               valutazioneObj.risultati.punteggio;

                // Fase 3: Gap analysis vs manuale adottato (TEMPERATURE ABBASSATA A 0.2)
                updateLoadingText('Fase 3/4: Analisi gap con manuale adottato...');
                const manualeInfo = MANUALI_DB[manuale] || {};
                const gapManuale = await callLLM( `Valuta il manuale "${manuale}" (${manualeInfo.editore || ''}) rispetto a questo programma usando il FRAMEWORK DI VALUTAZIONE MANUALI.

PROGRAMMA:
${testo.substring(0, 3000)}

CONTESTO:
- Classe di Laurea: ${contesto}
- CFU: ${cfu || 'Non specificato'}

CARATTERISTICHE MANUALE ${manuale}:
${JSON.stringify(manualeInfo.caratteristiche || [])}

FRAMEWORK VALUTAZIONE MANUALI (270 punti):
Valuta il manuale su 5 criteri principali considerando le PRIORITÀ per ${contesto}:

1. OBIETTIVI FORMATIVI (max 40):
   - Completezza, Chiarezza, Coerenza standard, Interdisciplinarità

2. CONTENUTI PROGRAMMATICI (max 130):
   Valuta copertura dei 10 MODULI rispetto al programma:
   - MOD-01 Struttura/legami, MOD-02 Nomenclatura, MOD-03 Gruppi funzionali
   - MOD-04 Stereochimica, MOD-05 Meccanismi, MOD-06 Aromatici
   - MOD-07 Carbonilici, MOD-08 Polimeri, MOD-09 Biomolecole, MOD-10 Tecniche
   
   PRIORITÀ ${contesto}:
   - L-2/L-13: MOD-09 (biomolecole) e MOD-10 (tecniche) CRITICI
   - L-29: MOD-04 (stereochimica) e MOD-02 (nomenclatura) CRITICI
   - L-8/9: MOD-08 (polimeri) e MOD-10 (tecniche) CRITICI
   - L-32: MOD-08-ARG-05 (degradazione ambientale) CRITICO

3. METODOLOGIA DIDATTICA (max 40):
   - Didattica attiva, Materiali, Valutazione, Supporto studente

4. ALLINEAMENTO CURRICULUM (max 30):
   - Coerenza moduli, Progressione, Flessibilità

5. RISULTATI ATTESI (max 30):
   - Competenze tecnico-scientifiche, trasversali, preparazione professionale

ANALISI DETTAGLIATA:
1. Argomenti del programma COPERTI dal manuale
2. Argomenti del programma NON COPERTI (gap) - CRITICI per ${contesto}
3. Argomenti del manuale ECCEDENTI rispetto al programma
4. PUNTI DI FORZA del manuale per questo programma
5. PUNTI DI DEBOLEZZA del manuale per questo programma

Rispondi SOLO con un JSON valido:
{
  "coperti": ["arg1", "arg2"],
  "gap": ["arg_mancante1", "arg_mancante2"],
  "eccedenti": ["arg_extra1"],
  "punti_forza": ["forza1", "forza2", "forza3"],
  "punti_debolezza": ["debolezza1", "debolezza2"],
  "copertura_percentuale": numero,
  "compatibilita": "Alta/Media/Bassa",
  "punteggio_framework": numero_su_270,
  "note": "commento dettagliato sulla compatibilità considerando le priorità ${contesto}"
}`, 0.2);

                const gapManualeObj = JSON.parse(gapManuale.replace(/```json|```/g, '').trim());

                // Fase 3b: Analisi gap manuali alternativi (se presenti)
                const gapAlternativi = [];
                if (manualiAlternativi.length > 0) {
                    updateLoadingText(`Fase 3b/4: Analisi ${manualiAlternativi.length} manuali alternativi...`);
                    
                    for (const manualeAlt of manualiAlternativi) {
                        const manualeInfo = MANUALI_DB[manualeAlt] || {};
                        const gapAlt = await callLLM(`Confronta questo programma universitario con il manuale "${manualeAlt}" (${manualeInfo.editore || ''}).

Programma:
${testo.substring(0, 3000)}

Caratteristiche manuale ${manualeAlt}:
${JSON.stringify(manualeInfo.caratteristiche || [])}

Identifica:
1. Argomenti del programma COPERTI dal manuale
2. Argomenti del programma NON COPERTI (gap)
3. Argomenti del manuale ECCEDENTI rispetto al programma
4. Punti di forza del manuale per questo programma
5. Punti di debolezza del manuale per questo programma

Rispondi SOLO con un JSON valido:
{
  "manuale": "${manualeAlt}",
  "coperti": ["arg1", "arg2", "arg3"],
  "gap": ["arg_mancante1", "arg_mancante2"],
  "eccedenti": ["arg_extra1", "arg_extra2"],
  "copertura_percentuale": numero,
  "compatibilita": "Alta/Media/Bassa",
  "punti_forza": ["forza1", "forza2", "forza3"],
  "punti_debolezza": ["debolezza1", "debolezza2"],
  "note": "commento dettagliato sulla compatibilità e raccomandazione"
}`, 0.2);

                        try {
                            console.log(`Risposta GPT per ${manualeAlt}:`, gapAlt);
                            const gapAltObj = JSON.parse(gapAlt.replace(/```json|```/g, '').trim());
                            console.log(`JSON parsed per ${manualeAlt}:`, gapAltObj);
                            gapAlternativi.push(gapAltObj);
                        } catch (e) {
                            console.error(`Errore parsing gap ${manualeAlt}:`, e);
                            console.error(`Risposta raw:`, gapAlt);
                        }
                    }
                }

                // Fase 4: Valutazione Zanichelli (TEMPERATURE ABBASSATA A 0.2)
                updateLoadingText('Fase 4/4: Valutazione compatibilità Zanichelli...');
                const zanichelli = await callLLM( `Valuta la compatibilità di TUTTI E 3 i manuali Zanichelli di Chimica Organica con questo programma:

1. Hart - Fondamenti di chimica organica (520 pag, €65, livello base)
2. McMurry - Fondamenti di chimica organica (536 pag, €67.50, livello intermedio)  
3. McMurry - Chimica organica: approccio biologico (896 pag, €101.40, livello avanzato con focus bio)

Programma:
${testo.substring(0, 2000)}

Contesto: ${contesto}
Bibliografia adottata: ${Array.isArray(manuale) ? manuale.join(' + ') : manuale}

Ordina i 3 manuali per compatibilità (dal più al meno compatibile) e fornisci per ognuno:
- Punteggio compatibilità (0-100)
- Punti di forza specifici
- Gap specifici (se presenti)
- Quando preferirlo (contesto ideale)
- Confronto con bibliografia adottata

Rispondi SOLO con un JSON valido:
{
  "raccomandato": {
    "titolo": "Nome manuale più compatibile",
    "punteggio": numero,
    "compatibilita": "Alta/Media/Bassa",
    "punti_forza": ["punto1", "punto2"],
    "gap": ["gap1", "gap2"],
    "quando_preferirlo": "descrizione contesto ideale",
    "confronto_bibliografia": "confronto con bibliografia adottata",
    "prezzo": "€XX"
  },
  "alternative": [
    {
      "titolo": "Seconda scelta",
      "punteggio": numero,
      "compatibilita": "Alta/Media/Bassa", 
      "punti_forza": ["punto1", "punto2"],
      "gap": ["gap1", "gap2"],
      "quando_preferirlo": "descrizione",
      "confronto_bibliografia": "confronto",
      "prezzo": "€XX"
    },
    {
      "titolo": "Terza scelta",
      "punteggio": numero,
      "compatibilita": "Alta/Media/Bassa",
      "punti_forza": ["punto1", "punto2"], 
      "gap": ["gap1", "gap2"],
      "quando_preferirlo": "descrizione",
      "confronto_bibliografia": "confronto",
      "prezzo": "€XX"
    }
  ],
  "raccomandazioni_generali": ["racc1", "racc2"]
}`, 0.2);

                const zanichelliObj = JSON.parse(zanichelli.replace(/```json|```/g, '').trim());

                // Crea risultato
                currentProgramma = {
                    id: Date.now(),
                    ...metadataObj,
                    contesto: contesto,
                    manuale_adottato: manuale,
                    manuali_alternativi: manualiAlternativi,
                    cfu: cfu || null,
                    ore: ore || null,
                    punteggi: {
                        obiettivi: valutazioneObj.obiettivi.punteggio,
                        contenuti: valutazioneObj.contenuti.punteggio,
                        metodologia: valutazioneObj.metodologia.punteggio,
                        allineamento: valutazioneObj.allineamento.punteggio,
                        risultati: valutazioneObj.risultati.punteggio,
                        totale: totale
                    },
                    valutazione: valutazioneObj,
                    gap_manuale: gapManualeObj,
                    gap_alternativi: gapAlternativi,
                    zanichelli: zanichelliObj,
                    created_at: new Date().toISOString()
                };

                // Salva nello storico
                saveToStorico(currentProgramma);

                // Mostra risultati
                mostraRisultati(currentProgramma);

            } catch (error) {
                showError('Errore durante l\'analisi: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('btnAnalizza').disabled = false;
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        // Chiamata LLM Unificata (OpenAI o Perplexity)
        async function callLLM(prompt, temperature) {
            const provider = localStorage.getItem('ai_provider') || 'openai';
            
            if (provider === 'openai') {
                return await callOpenAI(prompt, temperature);
            } else {
                return await callPerplexity(prompt, temperature);
            }
        }
        
        async function callOpenAI(prompt, temperature) {
            const apiKey = localStorage.getItem('openai_api_key') || null; // null = userà quella su Netlify
            const model = localStorage.getItem('openai_model') || 'gpt-4.1-mini';
            
            // Usa il proxy Netlify invece della chiamata diretta
            const response = await fetch('/.netlify/functions/openai-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey: apiKey,
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: temperature,
                    max_tokens: 16000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || error.message || 'Errore API OpenAI');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }
        
        async function callPerplexity(prompt, temperature) {
            const apiKey = localStorage.getItem('perplexity_api_key');
            const model = localStorage.getItem('perplexity_model') || 'llama-3.1-sonar-large-128k-online';
            
            if (!apiKey) {
                throw new Error('Chiave API Perplexity non configurata');
            }
            
            // Usa il proxy Netlify invece della chiamata diretta
            const response = await fetch('/.netlify/functions/perplexity-proxy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey: apiKey,
                    model: model,
                    messages: [{role: 'user', content: prompt}],
                    temperature: temperature,
                    max_tokens: 16000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || error.message || 'Errore API Perplexity');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // Mostra risultati (continua nel prossimo blocco...)
        function mostraRisultati(prog) {
            const getPunteggioColor = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'text-green-600' : perc >= 60 ? 'text-yellow-600' : 'text-red-600';
            };

            const getPunteggioLabel = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'Ottimo' : perc >= 60 ? 'Buono' : perc >= 40 ? 'Sufficiente' : 'Insufficiente';
            };

            const getCompatibilitaColor = (comp) => {
                return comp === 'Alta' ? 'text-green-600' : comp === 'Media' ? 'text-yellow-600' : 'text-red-600';
            };

            const html = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-start justify-between">
                            <div>
                                <h2 class="text-2xl font-bold">${prog.denominazione_corso}</h2>
                                <div class="mt-2 space-y-1 text-sm text-gray-600">
                                    <p><strong>Università:</strong> ${prog.università}</p>
                                    <p><strong>Corso di Laurea:</strong> ${prog.corso_laurea_nome} (${prog.contesto})</p>
                                    ${prog.docente ? `<p><strong>Docente:</strong> ${prog.docente}</p>` : ''}
                                    ${prog.cfu ? `<p><strong>CFU:</strong> ${prog.cfu}</p>` : ''}
                                    ${prog.ore ? `<p><strong>Ore:</strong> ${prog.ore}</p>` : ''}
                                    <p><strong>Manuale Adottato:</strong> ${prog.manuale_adottato}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-bold text-indigo-600">
                                    ${prog.punteggi.totale}<span class="text-xl text-gray-400">/270</span>
                                </div>
                                <p class="text-sm font-medium mt-1 ${getPunteggioColor(prog.punteggi.totale, 270)}">
                                    ${getPunteggioLabel(prog.punteggi.totale, 270)}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Sezione 1: Analisi Programma -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">1</span>
                            Analisi Dettagliata Programma
                        </h3>
                        
                        <!-- Punteggi -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            ${['obiettivi', 'contenuti', 'metodologia', 'allineamento', 'risultati'].map(dim => {
                                const max = dim === 'contenuti' ? 130 : dim === 'obiettivi' || dim === 'metodologia' ? 40 : 30;
                                const label = {obiettivi: 'Obiettivi Formativi', contenuti: 'Contenuti Programmatici', 
                                              metodologia: 'Metodologia Didattica', allineamento: 'Allineamento Curriculum', 
                                              risultati: 'Risultati Attesi'}[dim];
                                return `
                                    <div class="border rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-600 mb-2">${label}</h4>
                                        <div class="flex items-baseline space-x-2 mb-2">
                                            <span class="text-3xl font-bold ${getPunteggioColor(prog.punteggi[dim], max)}">
                                                ${prog.punteggi[dim]}
                                            </span>
                                            <span class="text-gray-400">/${max}</span>
                                        </div>
                                        ${prog.valutazione[dim]?.giudizio ? `<p class="text-sm font-semibold ${getPunteggioColor(prog.punteggi[dim], max)} mb-1">${prog.valutazione[dim].giudizio}</p>` : ''}
                                        ${prog.valutazione[dim]?.note ? `<p class="text-xs text-gray-600">${prog.valutazione[dim].note}</p>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${prog.valutazione.sintesi ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Sintesi dell'Analisi</h4>
                                <p class="text-sm text-gray-700">${prog.valutazione.sintesi}</p>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Sezione 2: Gap Analysis Manuale Adottato -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2</span>
                            Analisi Manuale Adottato: ${prog.manuale_adottato}
                        </h3>
                        
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Compatibilità con Programma</span>
                                <span class="text-lg font-bold ${getCompatibilitaColor(prog.gap_manuale.compatibilita)}">
                                    ${prog.gap_manuale.compatibilita}
                                </span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full" style="width: ${prog.gap_manuale.copertura_percentuale}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Copertura: ${prog.gap_manuale.copertura_percentuale}%</p>
                        </div>

                        ${prog.gap_manuale.note ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-900">${prog.gap_manuale.note}</p>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${prog.gap_manuale.coperti?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Argomenti Coperti
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.coperti.map(arg => 
                                            `<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${prog.gap_manuale.gap?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Gap (Non Coperti)
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.gap.map(arg => 
                                            `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${prog.gap_manuale.eccedenti?.length ? `
                                <div>
                                    <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        <svg class="h-4 w-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Argomenti Eccedenti
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${prog.gap_manuale.eccedenti.map(arg => 
                                            `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${arg}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Sezione 2b: Confronto Manuali Alternativi -->
                    ${prog.gap_alternativi && prog.gap_alternativi.length > 0 ? `
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">2b</span>
                                Confronto Manuali Alternativi
                            </h3>
                            
                            <p class="text-sm text-gray-600 mb-4">Valutazione rapida dei manuali alternativi selezionati</p>
                            
                            <div class="space-y-6">
                                ${prog.gap_alternativi.map(alt => `
                                    <div class="border-2 rounded-lg p-6 hover:shadow-lg transition">
                                        <div class="flex items-center justify-between mb-4">
                                            <h4 class="text-lg font-bold text-gray-900">${alt.manuale}</h4>
                                            <span class="px-3 py-1 rounded-full text-sm font-bold ${getCompatibilitaColor(alt.compatibilita)}">${alt.compatibilita}</span>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="text-sm text-gray-600">Copertura Programma</span>
                                                <span class="text-lg font-bold text-indigo-600">${alt.copertura_percentuale}%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-3">
                                                <div class="bg-indigo-600 h-3 rounded-full transition-all" style="width: ${alt.copertura_percentuale}%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            ${alt.punti_forza && alt.punti_forza.length > 0 ? `
                                                <div class="bg-green-50 rounded-lg p-3">
                                                    <h5 class="text-sm font-semibold text-green-900 mb-2 flex items-center">
                                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                        </svg>
                                                        Punti di Forza
                                                    </h5>
                                                    <ul class="space-y-1">
                                                        ${alt.punti_forza.map(f => `<li class="text-xs text-green-800">• ${f}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            ${alt.punti_debolezza && alt.punti_debolezza.length > 0 ? `
                                                <div class="bg-orange-50 rounded-lg p-3">
                                                    <h5 class="text-sm font-semibold text-orange-900 mb-2 flex items-center">
                                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                        </svg>
                                                        Punti di Debolezza
                                                    </h5>
                                                    <ul class="space-y-1">
                                                        ${alt.punti_debolezza.map(d => `<li class="text-xs text-orange-800">• ${d}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        ${alt.gap && alt.gap.length > 0 ? `
                                            <div class="mb-3">
                                                <h5 class="text-sm font-semibold text-red-900 mb-2">Gap (Argomenti Non Coperti)</h5>
                                                <div class="flex flex-wrap gap-1">
                                                    ${alt.gap.map(g => `<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">${g}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        ${alt.note ? `
                                            <div class="bg-gray-50 rounded-lg p-3 mt-3">
                                                <p class="text-sm text-gray-700">${alt.note}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Sezione 3: Valutazione Zanichelli -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <span class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3">3</span>
                            Valutazione Compatibilità Manuale Zanichelli
                        </h3>
                        
                        <!-- Manuale Raccomandato -->
                        ${prog.zanichelli.raccomandato ? `
                            <div class="bg-green-50 border-2 border-green-500 rounded-lg p-6 mb-6">
                                <div class="flex items-center mb-4">
                                    <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold mr-3">⭐ RACCOMANDATO</span>
                                    <h4 class="text-xl font-bold text-green-900">${prog.zanichelli.raccomandato.titolo}</h4>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Compatibilità</p>
                                        <p class="text-2xl font-bold ${getCompatibilitaColor(prog.zanichelli.raccomandato.compatibilita)}">${prog.zanichelli.raccomandato.compatibilita}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Punteggio</p>
                                        <p class="text-2xl font-bold text-green-600">${prog.zanichelli.raccomandato.punteggio}/100</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Prezzo</p>
                                        <p class="text-2xl font-bold text-gray-900">${prog.zanichelli.raccomandato.prezzo}</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${prog.zanichelli.raccomandato.punti_forza?.length ? `
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-700 mb-2">✅ Punti di Forza</h5>
                                            <ul class="space-y-1">
                                                ${prog.zanichelli.raccomandato.punti_forza.map(pf => 
                                                    `<li class="text-sm text-gray-600 flex items-start">
                                                        <span class="text-green-600 mr-2">•</span>${pf}
                                                    </li>`
                                                ).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}

                                    ${prog.zanichelli.raccomandato.gap?.length ? `
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-700 mb-2">⚠️ Gap</h5>
                                            <ul class="space-y-1">
                                                ${prog.zanichelli.raccomandato.gap.map(g => 
                                                    `<li class="text-sm text-gray-600 flex items-start">
                                                        <span class="text-yellow-600 mr-2">•</span>${g}
                                                    </li>`
                                                ).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>

                                ${prog.zanichelli.raccomandato.quando_preferirlo ? `
                                    <div class="bg-white rounded-lg p-4 mt-4">
                                        <h5 class="text-sm font-medium text-gray-700 mb-2">💡 Quando Preferirlo</h5>
                                        <p class="text-sm text-gray-600">${prog.zanichelli.raccomandato.quando_preferirlo}</p>
                                    </div>
                                ` : ''}

                                ${prog.zanichelli.raccomandato.confronto_bibliografia ? `
                                    <div class="bg-white rounded-lg p-4 mt-4">
                                        <h5 class="text-sm font-medium text-gray-700 mb-2">📚 Confronto con Bibliografia Adottata</h5>
                                        <p class="text-sm text-gray-600">${prog.zanichelli.raccomandato.confronto_bibliografia}</p>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <!-- Alternative -->
                        ${prog.zanichelli.alternative?.length ? `
                            <div class="mb-6">
                                <h4 class="text-lg font-bold mb-4">Alternative Zanichelli</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${prog.zanichelli.alternative.map(alt => `
                                        <div class="border rounded-lg p-4 bg-gray-50">
                                            <div class="flex items-center justify-between mb-3">
                                                <h5 class="font-bold text-gray-900">${alt.titolo}</h5>
                                                <span class="text-sm font-medium ${getCompatibilitaColor(alt.compatibilita)}">${alt.compatibilita}</span>
                                            </div>
                                            
                                            <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
                                                <div>
                                                    <span class="text-gray-600">Punteggio:</span>
                                                    <span class="font-bold">${alt.punteggio}/100</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-600">Prezzo:</span>
                                                    <span class="font-bold">${alt.prezzo}</span>
                                                </div>
                                            </div>

                                            ${alt.punti_forza?.length ? `
                                                <div class="mb-2">
                                                    <p class="text-xs font-medium text-gray-700 mb-1">✅ Punti di Forza</p>
                                                    <ul class="text-xs text-gray-600 space-y-1">
                                                        ${alt.punti_forza.slice(0,2).map(pf => `<li>• ${pf}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}

                                            ${alt.gap?.length ? `
                                                <div class="mb-2">
                                                    <p class="text-xs font-medium text-gray-700 mb-1">⚠️ Gap</p>
                                                    <ul class="text-xs text-gray-600 space-y-1">
                                                        ${alt.gap.slice(0,2).map(g => `<li>• ${g}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}

                                            ${alt.quando_preferirlo ? `
                                                <div class="bg-white rounded p-2 mt-2">
                                                    <p class="text-xs"><strong>💡 Quando preferirlo:</strong> ${alt.quando_preferirlo}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Raccomandazioni Generali -->
                        ${prog.zanichelli.raccomandazioni_generali?.length ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Raccomandazioni Generali</h4>
                                <ul class="space-y-1">
                                    ${prog.zanichelli.raccomandazioni_generali.map(racc => 
                                        `<li class="text-sm text-gray-600 flex items-start">
                                            <span class="text-indigo-600 mr-2">→</span>${racc}
                                        </li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="showView('upload'); resetForm();" class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Nuova Analisi
                        </button>
                        <button onclick="exportResults()" class="px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                            Esporta Risultati
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('viewRisultati').innerHTML = html;
            showView('risultati');
        }

        function resetForm() {
            document.getElementById('fileInput').value = '';
            document.getElementById('testoInput').value = '';
            document.getElementById('contestoSelect').value = '';
            document.getElementById('manualeSelect').value = '';
            document.getElementById('cfuInput').value = '';
            document.getElementById('oreInput').value = '';
            document.getElementById('fileNameDisplay').textContent = 'Clicca per selezionare un file';
            fileContent = null;
        }

        function exportResults() {
            if (!currentProgramma) return;
            const dataStr = JSON.stringify(currentProgramma, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analisi_${currentProgramma.id}.json`;
            link.click();
        }

        // Storico
        function saveToStorico(prog) {
            let storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            storico.unshift(prog);
            if (storico.length > 50) storico = storico.slice(0, 50);
            localStorage.setItem('storico_analisi', JSON.stringify(storico));
            loadStorico();
        }

        function loadStorico() {
            const storico = JSON.parse(localStorage.getItem('storico_analisi') || '[]');
            const container = document.getElementById('storicoContent');
            
            if (storico.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun programma analizzato</p>';
                return;
            }

            const getPunteggioColor = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'text-green-600' : perc >= 60 ? 'text-yellow-600' : 'text-red-600';
            };

            const getPunteggioLabel = (p, max) => {
                const perc = (p / max) * 100;
                return perc >= 80 ? 'Ottimo' : perc >= 60 ? 'Buono' : perc >= 40 ? 'Sufficiente' : 'Insufficiente';
            };

            container.innerHTML = storico.map(prog => `
                <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition" onclick='visualizzaProgramma(${JSON.stringify(prog).replace(/'/g, "&apos;")})'>
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">${prog.denominazione_corso}</h3>
                            <p class="text-sm text-gray-600">${prog.università} - ${prog.contesto}</p>
                            <p class="text-xs text-gray-500 mt-1">Manuale: ${prog.manuale_adottato} | ${new Date(prog.created_at).toLocaleDateString('it-IT')}</p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="text-2xl font-bold text-indigo-600">
                                ${prog.punteggi.totale}<span class="text-sm text-gray-400">/270</span>
                            </div>
                            <p class="text-xs font-medium ${getPunteggioColor(prog.punteggi.totale, 270)}">
                                ${getPunteggioLabel(prog.punteggi.totale, 270)}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function visualizzaProgramma(prog) {
            currentProgramma = prog;
            mostraRisultati(prog);
        }
    </script>

</body>
</html>
